<!doctype html><html lang=ja dir=ltr><head><title>AWS KMSの使い方 :: Jot down for myself - Technical notes on AWS, Go, React, etc.</title>
<meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="AWS KMSとは AWS Key Management Service とは AWS Key Management Service (AWS KMS) は、データの暗号化に使用される暗号化キーの作成と管理を容易にするマネージド型サービスです。AWS KMS は、A"><meta name=keywords content="aws,golang,react,typescript,mysql"><meta name=robots content="noodp"><meta property="og:url" content="https://techteco.github.io/2018/01/26/kms/"><meta property="og:site_name" content="Jot down for myself"><meta property="og:title" content="AWS KMSの使い方"><meta property="og:description" content="AWS CLIからのAWS KMSの基本的な使い方"><meta property="og:locale" content="ja"><meta property="og:type" content="article"><meta property="article:section" content="post"><meta property="article:published_time" content="2018-01-26T22:00:00+09:00"><meta property="article:modified_time" content="2024-05-24T16:04:29+09:00"><meta property="article:tag" content="Aws Cli"><meta property="article:tag" content="Cloudformation"><meta property="article:tag" content="Kms"><meta name=twitter:card content="summary"><meta name=twitter:title content="AWS KMSの使い方"><meta name=twitter:description content="AWS CLIからのAWS KMSの基本的な使い方"><link rel=canonical href=https://techteco.github.io/2018/01/26/kms/><link rel="shortcut icon" href=/favicon.ico><link rel=stylesheet href=/css/index.min.5d96433bd17079764d5a8866addd6d7848ea8295977a06688f43c5be97af544e.css><script type=application/ld+json>{"@context":"https://schema.org","@type":"Article","author":{"@type":"Person","name":"TechTeco"},"dateModified":"2024-05-24T16:04:29+09:00","datePublished":"2018-01-26T22:00:00+09:00","description":"AWS KMSとは AWS Key Management Service とは AWS Key Management Service (AWS KMS) は、データの暗号化に使用される暗号化キーの作成と管理を容易にするマネージド型サービスです。AWS KMS は、A","name":"AWS KMSの使い方","url":"https://techteco.github.io/2018/01/26/kms/"}</script><script async src="https://www.googletagmanager.com/gtag/js?id=G-ML7QTSL8BR"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-ML7QTSL8BR")</script><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2458671576041251" crossorigin=anonymous></script></head><body class="flex flex-col min-h-screen w-full bg-slate-50 dark:bg-gray-800"><header class="flex flex-none justify-center z-10"><div class="flex flex-row gap justify-between w-full max-w-4xl lg:max-w-5xl h-12 mt-3"><div class="flex-none ml-2 md:ml-0"><a href=/><img class="h-12 w-12 rounded-full" src=/images/button-305726_1280.png alt=logo></a></div><div class=flex-1></div><div class=flex-none></div><div class="flex-none mx-1"></div><div class="flex-none md:hidden"><a href=/search/ class="inline-flex items-center p-2 text-sm text-slate-800 dark:text-slate-200 rounded-lg" aria-controls=navbar-menu aria-expanded=false><span class=sr-only></span>
<i class="w-8 h-8"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M10 10m-7 0a7 7 0 1014 0A7 7 0 103 10"/><path d="M21 21l-6-6"/></svg></i></a></div><div class="darkmode-toggle flex flex-none mr-2 md:mr-0"><label for=darkmode-toggle class="flex items-center px-3 cursor-pointer rounded-full bg-gray-100 dark:bg-gray-600" title><input name=darkmode-toggle id=darkmode-toggle type=checkbox class="sr-only peer" aria-label><div class="group flex flex-row gap-1 justify-center h-8 px-1 rounded-full bg-white dark:bg-gray-700"><i class="h-6 w-6 flex-none rounded-full bg-yellow-400 place-self-center peer-checked:group-[]:invisible"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brightness-down" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M12 12m-3 0a3 3 0 106 0 3 3 0 10-6 0"/><path d="M12 5v.01"/><path d="M17 7v.01"/><path d="M19 12v.01"/><path d="M17 17v.01"/><path d="M12 19v.01"/><path d="M7 17v.01"/><path d="M5 12v.01"/><path d="M7 7v.01"/></svg>
</i><i class="h-6 w-6 flex-none rounded-full place-self-center invisible peer-checked:group-[]:visible"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-moon-stars" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M12 3c.132.0.263.0.393.0a7.5 7.5.0 007.92 12.446A9 9 0 1112 2.992z"/><path d="M17 4a2 2 0 002 2 2 2 0 00-2 2 2 2 0 00-2-2 2 2 0 002-2"/><path d="M19 11h2m-1-1v2"/></svg></i></div></label></div></div></header><main class="flex flex-auto justify-center"><div class="w-full max-w-4xl lg:max-w-5xl"><div class="flex flex-col mt-6 mx-2 md:mx-0 rounded-lg overflow-hidden shadow-md bg-white dark:bg-gray-700"><div><a href=/2018/01/26/kms/></a></div><div class="flex flex-col gap-y-3 p-6"><h1 class="text-4xl font-semibold text-slate-800 dark:text-slate-100"><a href=/2018/01/26/kms/>AWS KMSの使い方</a></h1><h2 class="my-4 text-large text-slate-600 dark:text-slate-300">AWS CLIからのAWS KMSの基本的な使い方</h2><ul class="flex flex-row flex-wrap text-slate-500 dark:text-slate-300"><li><a href=/categories/aws/ class="text-sm mr-2 px-2 py-1 rounded border border-emerald-800 bg-emerald-800 text-slate-50">AWS</a></li><li><a href=/tags/aws-cli/ class="flex flex-row text-sm mr-2 py-1"><i class="h-5 w-5 flex-none"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M5 9h14"/><path d="M5 15h14"/><path d="M11 4 7 20"/><path d="M17 4l-4 16"/></svg>
</i><span class=ml-0>aws cli</span></a></li><li><a href=/tags/cloudformation/ class="flex flex-row text-sm mr-2 py-1"><i class="h-5 w-5 flex-none"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M5 9h14"/><path d="M5 15h14"/><path d="M11 4 7 20"/><path d="M17 4l-4 16"/></svg>
</i><span class=ml-0>cloudformation</span></a></li><li><a href=/tags/kms/ class="flex flex-row text-sm mr-2 py-1"><i class="h-5 w-5 flex-none"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M5 9h14"/><path d="M5 15h14"/><path d="M11 4 7 20"/><path d="M17 4l-4 16"/></svg>
</i><span class=ml-0>kms</span></a></li></ul><div class="flex flex-col gap-y-1 md:flex-row md:gap-y-0 md:gap-x-4 text-slate-500 dark:text-slate-300"><div class="flex flex-row text-base gap-x-1"><i class="h-6 w-6 flex-none"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M4 7a2 2 0 012-2h12a2 2 0 012 2v12a2 2 0 01-2 2H6a2 2 0 01-2-2V7z"/><path d="M16 3v4"/><path d="M8 3v4"/><path d="M4 11h16"/><path d="M11 15h1"/><path d="M12 15v3"/></svg>
</i><time datetime=2018-01-26T22:00:00+09:00>2018-01-26</time></div></div><section class="prose prose-slate dark:prose-invert w-full max-w-4xl lg:max-w-5xl mt-6"><h2></h2><aside><nav id=TableOfContents><ul><li><a href=#csk作成>CSK作成</a><ul><li><a href=#定義ファイル>定義ファイル</a></li><li><a href=#cloudformationの実行>Cloudformationの実行</a></li></ul></li><li><a href=#cskのaliasを作成>CSKのAliasを作成</a><ul><li><a href=#定義ファイル-1>定義ファイル</a></li><li><a href=#cloudformationの実行-1>Cloudformationの実行</a></li></ul></li><li><a href=#作成されたcskの確認>作成されたCSKの確認</a></li></ul></nav></aside></section><article class="mt-6 w-full max-w-4xl lg:max-w-5xl prose prose-slate dark:prose-invert prose-quoteless post-content"><h1 id=aws-kmsとは>AWS KMSとは</h1><p><a href=https://docs.aws.amazon.com/ja_jp/kms/latest/developerguide/overview.html target=_blank rel=noopener>AWS Key Management Service とは</a></p><blockquote><p>AWS Key Management Service (AWS KMS) は、データの暗号化に使用される暗号化キーの作成と管理を容易にするマネージド型サービスです。AWS KMS は、Amazon Elastic Block Store (Amazon EBS)、Amazon Simple Storage Service (Amazon S3)、Amazon Redshift、Amazon Elastic Transcoder、Amazon WorkMail、Amazon Relational Database Service (Amazon RDS) などの他の AWS サービスと統合されており、ユーザーが管理する暗号化キーでのデータの暗号化を簡単にします。また AWS KMS は AWS CloudTrail とも統合されており、キーの使用ログを表示できるため、監査、規制、およびコンプライアンスの要求に応えるために役立ちます。</p></blockquote><h1 id=cloudformationでcmkを作成>CloudformationでCMKを作成</h1><h2 id=csk作成>CSK作成</h2><p>AWS Key Management Service (AWS KMS) でカスタマーマスターキー (CMK) を作成します。</p><p><a href=https://docs.aws.amazon.com/ja_jp/AWSCloudFormation/latest/UserGuide/aws-resource-kms-key.html target=_blank rel=noopener>AWS::KMS::Key</a></p><h3 id=定義ファイル>定義ファイル</h3><ul><li>key.yaml</li></ul><pre><code class="language-yaml line-numbers">AWSTemplateFormatVersion: &#34;2010-09-09&#34;
Description: &#34;Cloudformation Sample : Create Sample KMS Key&#34;
Parameters:
  pTagKey:
    Type: String
  pTagValue:
    Type: String
Resources:
  SampleKey:
    Type: &#34;AWS::KMS::Key&#34;
    Properties:
      Description: &#34;A sample key&#34;
      KeyPolicy:
        Version: &#34;2012-10-17&#34;
        Id: &#34;key-default-1&#34;
        Statement:
          -
            Sid: Enable IAM User Permissions
            Effect: Allow
            Principal:
              AWS: !Join
                - &#39;&#39;
                - - &#39;arn:aws:iam::&#39;
                  - !Ref &#39;AWS::AccountId&#39;
                  - &#39;:root&#39;
            Action: &#39;kms:*&#39;
            Resource: &#39;*&#39;
      Tags:
        - Key: !Ref pTagKey
          Value: !Ref pTagValue
Outputs:
  SampleKey:
    Value: !Ref SampleKey
    Export:
      Name: SampleKey
</code></pre><h3 id=cloudformationの実行>Cloudformationの実行</h3><pre><code class="language-bash line-numbers">$ CF_TAG_KEY=service
$ CF_TAG_NAME=sample
$ CF_STACK_NAME=sampleKMSKey

$ aws cloudformation create-stack \
--tags Key=${CF_TAG_KEY},Value=${CF_TAG_NAME} \
--stack-name ${CF_STACK_NAME} \
--template-body file:///$PWD/key.yaml \
--parameters \
ParameterKey=pTagKey,ParameterValue=${CF_TAG_KEY} \
ParameterKey=pTagValue,ParameterValue=${CF_TAG_NAME} \
| jq .
</code></pre><h2 id=cskのaliasを作成>CSKのAliasを作成</h2><p>AWS Key Management Service (AWS KMS) でカスタマーマスターキー (CMK) の表示名を作成します。</p><ul><li><a href=https://docs.aws.amazon.com/ja_jp/AWSCloudFormation/latest/UserGuide/aws-resource-kms-alias.html target=_blank rel=noopener>AWS::KMS::Alias</a></li></ul><h3 id=定義ファイル-1>定義ファイル</h3><ul><li>alias.yaml</li></ul><pre><code class="language-yaml line-numbers">AWSTemplateFormatVersion: &#34;2010-09-09&#34;
Description: &#34;Cloudformation Sample : Create Sample KMS Key Alias&#34;
Resources:
  SampleKeyAlias:
    Type: AWS::KMS::Alias
    Properties:
      AliasName: alias/SampleKeyAlias
      TargetKeyId: !ImportValue SampleKeyARN
</code></pre><h3 id=cloudformationの実行-1>Cloudformationの実行</h3><pre><code class="language-bash line-numbers">$ CF_TAG_KEY=service
$ CF_TAG_NAME=sample
$ CF_STACK_NAME=sampleKMSKeyAlias

$ aws cloudformation create-stack \
--tags Key=${CF_TAG_KEY},Value=${CF_TAG_NAME} \
--stack-name ${CF_STACK_NAME} \
--template-body file:///$PWD/alias.yaml \
| jq .
</code></pre><h2 id=作成されたcskの確認>作成されたCSKの確認</h2><p>AWS CLIで確認</p><p><a href=https://docs.aws.amazon.com/cli/latest/reference/kms/index.html target=_blank rel=noopener>AWS CLI KMS</a></p><pre><code class="language-bash line-numbers">$ aws kms list-keys
</code></pre><pre><code class="language-json line-numbers">{
    &#34;Keys&#34;: [
        {
            &#34;KeyId&#34;: &#34;XXXXXXXX-XXXX-XXXX-XXXXXXXXXXXXXXXXX&#34;,
            &#34;KeyArn&#34;: &#34;arn:aws:kms:ap-northeast-1:123456789012:key/XXXXXXXX-XXXX-XXXX-XXXXXXXXXXXXXXXXX&#34;
        }
    ]
}
</code></pre><p>alias（SampleKeyAlias）で検索</p><pre><code class="language-bash line-numbers">$ aws kms list-aliases | jq &#39;.Aliases[] | select( .AliasName | test(&#34;SampleKeyAlias&#34;))&#39;
</code></pre><pre><code class="language-json line-numbers">{
  &#34;AliasName&#34;: &#34;alias/SampleKeyAlias&#34;,
  &#34;AliasArn&#34;: &#34;arn:aws:kms:ap-northeast-1:123456789012:alias/SampleKeyAlias&#34;,
  &#34;TargetKeyId&#34;: &#34;XXXXXXXX-XXXX-XXXX-XXXXXXXXXXXXXXXXX&#34;
}
</code></pre><h1 id=暗号化encrypt>暗号化(encrypt)</h1><p><a href=https://docs.aws.amazon.com/cli/latest/reference/kms/encrypt.html target=_blank rel=noopener>AWS CLI KMS encrypt</a></p><p>ここでは、aliasを使って暗号化します。</p><pre><code class="language-bash line-numbers">$ aws kms encrypt \
--key-id alias/SampleKeyAlias \
--plaintext &#34;I am seacret word&#34;
</code></pre><p>出力</p><pre><code class="language-json line-numbers">{
    &#34;CiphertextBlob&#34;: &#34;AQICAHgiNRl&#43;XlUIXRhw4&#43;tLNMNgYcJYxkGHTirG5cXZvdUbxwHwVFktPdlZsI7tifaHUVk2AAAAbzBtBgkqhkiG9w0BBwagYDBeAgEAMFkGCSqGSIb3DQEHATAeBglghkgBZQMEAS4wEQQMwmujQIyOGHFjqkyJAgEQgCyWHiZUyquUAVWYOOwE0d2X&#43;Ij99UJatuYxTUSaWvrjQcnTnjhUHuMKTPXAbw==&#34;,
    &#34;KeyId&#34;: &#34;arn:aws:kms:ap-northeast-1:123456789012:key/XXXXXXXX-XXXX-XXXX-XXXXXXXXXXXXXXXXX&#34;
}
</code></pre><p><em><strong>CiphertextBlob</strong></em>が、&ldquo;I am seacret word"を暗号化してbase64でエンコードしたもののようです。</p><p>マニュアルの使い方の例としては、<em><strong>CiphertextBlob</strong></em>をbase64でデコードしたものバイナリをファイルに保存するようです。</p><pre><code class="language-bash line-numbers">$ aws kms encrypt \
--key-id alias/SampleKeyAlias \
--plaintext &#34;I am seacret word&#34; \
--output text \
--query CiphertextBlob \
| base64 --decode &gt; ExampleEncryptedFile
</code></pre><h1 id=複合化decrypt>複合化(decrypt)</h1><p>次に<em><strong>ExampleEncryptedFile</strong></em>の中身を復号化して取り出してみましょう。</p><p><a href=https://docs.aws.amazon.com/cli/latest/reference/kms/decrypt.html target=_blank rel=noopener>AWS CLI KMS decrypt</a></p><p>まずは、複合だけしてみる。</p><pre><code class="language-bash line-numbers">$ aws kms decrypt \
--ciphertext-blob fileb://ExampleEncryptedFile
</code></pre><pre><code class="language-json line-numbers">{
    &#34;KeyId&#34;: &#34;arn:aws:kms:ap-northeast-1:123456789012:key/XXXXXXXX-XXXX-XXXX-XXXXXXXXXXXXXXXXX&#34;,
    &#34;Plaintext&#34;: &#34;SSBhbSBzZWFjcmV0IHdvcmQ=&#34;
}
</code></pre><p>ファイルの中にKeyIdが含まれているので指定しなくても問題ないようですね。</p><p>取り出します。</p><pre><code class="language-bash line-numbers">$ aws kms decrypt \
--ciphertext-blob fileb://ExampleEncryptedFile \
--output text \
--query Plaintext \
| base64 --decode &gt; ExamplePlaintextFile
</code></pre><pre><code class="language-bash line-numbers">$ cat ExamplePlaintextFile
I am seacret word
</code></pre><p>問題なくとりだせました。</p><h1 id=まとめ>まとめ</h1><p>ソースコードにAPIのKEY等を埋め込めないことがほとんどなので、KMSつかってセキュアに扱いましょう。</p><p>使い方も慣れれば簡単ですね。次は、Lambdaでの使い方を整理していきます。</p></article></div></div></div></main><footer class="flex flex-none justify-center"><section class="flex flex-col md:flex-row mx-2 md:mx-0 gap-2 md:gap-0 justify-between w-full max-w-4xl lg:max-w-5xl py-6 text-slate-500 dark:text-slate-300"><div class="flex flex-row"></div><div class=grow></div><div class="flex flex-row"></div></section></footer><script src=/main.min.c6372b6836971865bd94bfde974748aca8415824a2facab6ccd66a87384bfacb.js></script><div class="hidden top-1 right-1" id=code-copy><i class="h-6 w-6 block"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copy" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M7 7m0 2.667A2.667 2.667.0 019.667 7h8.666A2.667 2.667.0 0121 9.667v8.666A2.667 2.667.0 0118.333 21H9.667A2.667 2.667.0 017 18.333z"/><path d="M4.012 16.737A2.005 2.005.0 013 15V5c0-1.1.9-2 2-2h10c.75.0 1.158.385 1.5 1"/></svg></i></div><div class="hidden top-1 right-1" id=code-copy-done><i class="h-6 w-6 block"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-check" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M5 12l5 5L20 7"/></svg></i></div><script src=/code-copy.min.e7b2a74adef1ed474c335c8bd5e7832b2316b8842b0f9184d65286c5bd64f51a.js></script></body></html>